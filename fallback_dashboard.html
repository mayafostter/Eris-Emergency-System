<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERIS - Emergency Response Intelligence System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #67e8f9);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            margin-top: 15px;
        }

        .status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #e2e8f0;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .simulation-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #cbd5e1;
            font-weight: 500;
        }

        .form-group select,
        .form-group input {
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            border-color: #06b6d4;
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group select option {
            background: #334155;
            color: white;
        }

        .btn {
            padding: 15px 32px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            transition: all 0.5s ease;
        }

        .metric-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .metric-timestamp {
            color: #64748b;
            font-size: 0.7rem;
            margin-top: 4px;
        }

        .agents-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .agent-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .agent-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .agent-name {
            font-weight: 600;
            color: #f1f5f9;
            font-size: 0.875rem;
        }

        .agent-details {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 2px;
        }

        .agent-status {
            background: #22c55e;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .agent-status.standby {
            background: #64748b;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            transition: width 0.7s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progress-shimmer 2s infinite;
        }

        @keyframes progress-shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .feed-area {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feed-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .feed-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }

        .feed-item.emergency {
            border-left-color: #ef4444;
        }

        .feed-item.social {
            border-left-color: #8b5cf6;
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .feed-source {
            font-weight: 600;
            color: #60a5fa;
            font-size: 0.875rem;
        }

        .feed-source.emergency {
            color: #fca5a5;
        }

        .feed-source.social {
            color: #c4b5fd;
        }

        .feed-timestamp {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .feed-content {
            color: #e2e8f0;
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .feed-engagement {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .hashtag {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 4px;
        }

        .log-area {
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            height: 200px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 8px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .log-entry:hover {
            opacity: 1;
        }

        .log-timestamp {
            color: #64748b;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-success {
            color: #22c55e;
        }

        .log-warning {
            color: #f59e0b;
        }

        .log-error {
            color: #ef4444;
        }

        .emergency-banner {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            display: none;
            animation: alertPulse 2s infinite;
        }

        .emergency-banner.active {
            display: block;
        }

        @keyframes alertPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .live-indicator::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .ai-indicator {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .ai-indicator::before {
            background: #3b82f6;
        }

        .no-data-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .no-data-placeholder .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Alert level colors */
        .alert-red {
            color: #ef4444;
        }

        .alert-orange {
            color: #f97316;
        }

        .alert-yellow {
            color: #eab308;
        }

        .alert-green {
            color: #22c55e;
        }

        /* Metric-specific colors */
        .metric-panic-low {
            color: #22c55e;
        }

        .metric-panic-medium {
            color: #eab308;
        }

        .metric-panic-high {
            color: #ef4444;
        }

        .metric-hospital-normal {
            color: #3b82f6;
        }

        .metric-hospital-warning {
            color: #eab308;
        }

        .metric-hospital-critical {
            color: #ef4444;
        }

        .metric-response-excellent {
            color: #22c55e;
        }

        .metric-response-good {
            color: #eab308;
        }

        .metric-response-poor {
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .agents-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h1>ERIS</h1>
                    <p style="font-size: 1.2rem; opacity: 0.9;">Emergency Response Intelligence System - Gemini 2.0
                        Flash Orchestrator</p>
                </div>
                <div class="status-indicator" id="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="connection-status">Connecting to backend...</span>
                </div>
            </div>
        </div>

        <!-- Emergency Alert Banner -->
        <div id="emergency-banner" class="emergency-banner">
            <h2>ACTIVE SIMULATION: <span id="alert-type">FLOOD</span></h2>
            <p>Simulation ID: <span id="current-sim-id">N/A</span> | Alert Level: <span id="alert-level">YELLOW</span>
            </p>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Simulation Control -->
            <div class="card">
                <h3>Simulation Control</h3>
                <div class="simulation-form">
                    <div class="form-group">
                        <label>Disaster Type</label>
                        <select id="disaster-type">
                            <option value="flood">Flood</option>
                            <option value="earthquake">Earthquake</option>
                            <option value="hurricane">Hurricane</option>
                            <option value="wildfire">Wildfire</option>
                            <option value="tsunami">Tsunami</option>
                            <option value="volcanic_eruption">Volcanic Eruption</option>
                            <option value="severe_storm">Severe Storm</option>
                            <option value="epidemic">Epidemic</option>
                            <option value="pandemic">Pandemic</option>
                            <option value="landslide">Landslide</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="location" value="Phuket, Thailand" placeholder="Enter location">
                    </div>
                    <div class="form-group">
                        <label>Severity: <span id="severity-display">7</span></label>
                        <input type="range" id="severity" min="1" max="10" value="7"
                            oninput="document.getElementById('severity-display').textContent = this.value">
                    </div>
                    <div class="form-group">
                        <label>Duration (hours)</label>
                        <input type="number" id="duration" min="1" max="24" value="4">
                    </div>
                    <button class="btn btn-primary" onclick="startSimulation()" id="start-btn">Start Simulation</button>
                    <button class="btn btn-danger" onclick="stopSimulation()" style="display: none;" id="stop-btn">Stop
                        Simulation</button>
                </div>
            </div>

            <!-- System Status -->
            <div class="card">
                <h3>System Status</h3>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" style="color: #22c55e;" id="backend-status">●</div>
                        <div class="metric-label">Backend</div>
                        <div class="metric-timestamp" id="backend-timestamp"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #3b82f6;" id="agents-count">10</div>
                        <div class="metric-label">AI Agents</div>
                        <div class="metric-timestamp">Gemini 2.0 Flash</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #f59e0b;" id="active-sims">0</div>
                        <div class="metric-label">Active Sims</div>
                        <div class="metric-timestamp" id="sim-timestamp"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #8b5cf6;" id="api-version">v0.5.0</div>
                        <div class="metric-label">Version</div>
                        <div class="metric-timestamp">Enhanced</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Metrics -->
        <div class="card full-width" style="margin-bottom: 30px;">
            <h3>Live Metrics
                <span class="live-indicator" id="metrics-live-indicator" style="display: none;">LIVE</span>
            </h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value metric-panic-low" id="panic-index">0%</div>
                    <div class="metric-label">Panic Index</div>
                    <div class="metric-timestamp" id="panic-timestamp"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-hospital-normal" id="hospital-capacity">65%</div>
                    <div class="metric-label">Hospital Capacity</div>
                    <div class="metric-timestamp" id="hospital-timestamp"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-response-excellent" id="emergency-response">95%</div>
                    <div class="metric-label">Emergency Response</div>
                    <div class="metric-timestamp" id="response-timestamp"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: #3b82f6;" id="population-affected">0</div>
                    <div class="metric-label">Population Affected</div>
                    <div class="metric-timestamp" id="population-timestamp"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: #f97316;" id="infrastructure-failures">0</div>
                    <div class="metric-label">Infrastructure Failures</div>
                    <div class="metric-timestamp" id="infrastructure-timestamp"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: #6366f1;" id="public-trust">80%</div>
                    <div class="metric-label">Public Trust</div>
                    <div class="metric-timestamp" id="trust-timestamp"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: #06b6d4;" id="evacuation-compliance">75%</div>
                    <div class="metric-label">Evacuation Compliance</div>
                    <div class="metric-timestamp" id="evacuation-timestamp"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value alert-green" id="alert-level-display">GREEN</div>
                    <div class="metric-label">Alert Level</div>
                    <div class="metric-timestamp" id="alert-timestamp"></div>
                </div>
            </div>
        </div>

        <!-- AI Agent Network -->
        <div class="card full-width" style="margin-bottom: 30px;">
            <h3>AI Agent Network</h3>
            <div class="agents-list" id="agents-list">
                <!-- Agents will be populated by JavaScript -->
            </div>
        </div>

        <!-- Emergency Feed and Social Media -->
        <div class="grid">
            <div class="card">
                <h3>Emergency Feed
                    <span class="live-indicator" id="emergency-live-indicator" style="display: none;">LIVE</span>
                </h3>
                <div class="feed-area" id="emergency-feed">
                    <div class="no-data-placeholder">
                        <div class="icon">No Data</div>
                        <p>No emergency feed available</p>
                        <p style="font-size: 0.875rem;">Start a simulation to see live updates</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Social Media Activity
                    <span class="ai-indicator" id="social-ai-indicator" style="display: none;">AI GENERATED</span>
                </h3>
                <div class="feed-area" id="social-feed">
                    <div class="no-data-placeholder">
                        <div class="icon">No Data</div>
                        <p>No social media activity</p>
                        <p style="font-size: 0.875rem;">AI-generated posts will appear here during simulation</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card full-width">
            <h3>System Activity Log</h3>
            <div class="log-area" id="activity-log">
                <div class="log-entry">
                    <span class="log-timestamp">[10:30:15]</span>
                    <span class="log-info">INFO</span> - ERIS v0.5.0 orchestrator initialized successfully
                </div>
                <div class="log-entry">
                    <span class="log-timestamp">[10:30:16]</span>
                    <span class="log-success">SUCCESS</span> - Gemini 2.0 Flash orchestrator active
                </div>
                <div class="log-entry">
                    <span class="log-timestamp">[10:30:17]</span>
                    <span class="log-success">SUCCESS</span> - 10-agent coordination system online (6 ADK + 4 Enhanced)
                </div>
                <div class="log-entry">
                    <span class="log-timestamp">[10:30:18]</span>
                    <span class="log-info">INFO</span> - Real-time AI content generation enabled
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://eris-backend-621360763676.us-central1.run.app';
        let currentSimulationId = null;
        let metricsPollingInterval = null;
        let feedPollingInterval = null;
        let connectionCheckInterval = null;

        // Agent definitions
        const agents = [
            { name: 'Emergency Response Coordinator', type: 'ADK', status: 'standby', progress: 0, efficiency: 95 },
            { name: 'Public Health Manager', type: 'ADK', status: 'standby', progress: 0, efficiency: 93 },
            { name: 'Infrastructure Manager', type: 'ADK', status: 'standby', progress: 0, efficiency: 97 },
            { name: 'Logistics Coordinator', type: 'ADK', status: 'standby', progress: 0, efficiency: 94 },
            { name: 'Communications Director', type: 'ADK', status: 'standby', progress: 0, efficiency: 92 },
            { name: 'Recovery Coordinator', type: 'ADK', status: 'standby', progress: 0, efficiency: 96 },
            { name: 'Hospital Load Modeler', type: 'Enhanced', status: 'standby', progress: 0, efficiency: 89 },
            { name: 'Public Behavior Simulator', type: 'Enhanced', status: 'standby', progress: 0, efficiency: 91 },
            { name: 'Social Media Dynamics', type: 'Enhanced', status: 'standby', progress: 0, efficiency: 88 },
            { name: 'News Coverage Simulator', type: 'Enhanced', status: 'standby', progress: 0, efficiency: 90 }
        ];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            checkBackendConnection();
            renderAgents();
            connectionCheckInterval = setInterval(checkBackendConnection, 10000);
            addLogEntry('INFO', 'Enhanced fallback dashboard initialized');
        });

        // Backend connection check
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    const data = await response.json();
                    updateConnectionStatus('connected', 'Connected to backend');
                    document.getElementById('backend-status').textContent = '●';
                    document.getElementById('backend-status').style.color = '#22c55e';
                    document.getElementById('backend-timestamp').textContent = new Date().toLocaleTimeString();

                    try {
                        const systemResponse = await fetch(`${API_BASE}/system/info`);
                        if (systemResponse.ok) {
                            const systemData = await systemResponse.json();
                            document.getElementById('api-version').textContent = `v${systemData.eris_version}`;
                            document.getElementById('agents-count').textContent = systemData.total_agent_types;
                        }
                    } catch (sysError) {
                        console.warn('Failed to get system info:', sysError);
                    }
                } else {
                    throw new Error('Backend not responding');
                }
            } catch (error) {
                updateConnectionStatus('disconnected', 'Backend disconnected');
                document.getElementById('backend-status').textContent = '●';
                document.getElementById('backend-status').style.color = '#ef4444';
                document.getElementById('backend-timestamp').textContent = 'Offline';
                addLogEntry('ERROR', 'Backend connection failed');
            }
        }

        // Update connection status
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('status-indicator');
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('connection-status');

            indicator.className = 'status-indicator';
            dot.className = 'status-dot';

            if (status === 'connected') {
                statusText.textContent = message;
            } else {
                indicator.classList.add('disconnected');
                dot.classList.add('disconnected');
                statusText.textContent = message;
                document.getElementById('start-btn').disabled = true;
            }

            if (status !== 'disconnected') {
                document.getElementById('start-btn').disabled = false;
            }
        }

        // Start simulation
        async function startSimulation() {
            const disasterType = document.getElementById('disaster-type').value;
            const location = document.getElementById('location').value;
            const severity = parseInt(document.getElementById('severity').value);
            const duration = parseInt(document.getElementById('duration').value);

            if (!location.trim()) {
                addLogEntry('ERROR', 'Please enter a location');
                alert('Please enter a location');
                return;
            }

            try {
                addLogEntry('INFO', `Starting enhanced ${disasterType} simulation in ${location}...`);

                const response = await fetch(`${API_BASE}/simulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        disaster_type: disasterType,
                        location: location,
                        severity: severity,
                        duration: duration
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSimulationId = data.simulation_id;

                    // Update UI
                    document.getElementById('current-sim-id').textContent = currentSimulationId.substring(0, 8) + '...';
                    document.getElementById('alert-type').textContent = disasterType.toUpperCase();
                    document.getElementById('emergency-banner').classList.add('active');
                    document.getElementById('start-btn').style.display = 'none';
                    document.getElementById('stop-btn').style.display = 'block';
                    document.getElementById('active-sims').textContent = '1';
                    document.getElementById('sim-timestamp').textContent = new Date().toLocaleTimeString();

                    // Show live indicators
                    document.getElementById('metrics-live-indicator').style.display = 'inline-flex';
                    document.getElementById('emergency-live-indicator').style.display = 'inline-flex';
                    document.getElementById('social-ai-indicator').style.display = 'inline-flex';

                    // Activate agents
                    agents.forEach(agent => {
                        agent.status = 'active';
                        agent.progress = Math.floor(Math.random() * 30) + 10;
                    });
                    renderAgents();

                    // Start enhanced polling
                    startEnhancedPolling();

                    addLogEntry('SUCCESS', `Enhanced simulation started (ID: ${currentSimulationId.substring(0, 8)})`);
                    addLogEntry('INFO', 'Gemini 2.0 Flash orchestrator deployed - Real-time AI generation active');

                    if (data.orchestrator_info && data.orchestrator_info.real_time_features) {
                        addLogEntry('SUCCESS', 'Real-time features activated: Dynamic metrics, AI social media, Live emergency feed');
                    }
                } else {
                    const errorData = await response.json();
                    addLogEntry('ERROR', `Failed to start simulation: ${errorData.detail}`);
                    alert(`Failed to start simulation: ${errorData.detail}`);
                }
            } catch (error) {
                addLogEntry('ERROR', `Network error: ${error.message}`);
                alert(`Error starting simulation: ${error.message}`);
            }
        }

        // Enhanced polling for real-time data
        function startEnhancedPolling() {
            if (!currentSimulationId) return;

            // Poll metrics every 3 seconds
            if (metricsPollingInterval) clearInterval(metricsPollingInterval);
            metricsPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/metrics/dashboard/${currentSimulationId}`);
                    if (response.ok) {
                        const data = await response.json();
                        updateMetricsDisplay(data.dashboard_data || {});
                        updateAgentProgress();
                    }
                } catch (error) {
                    console.error('Metrics polling error:', error);
                }
            }, 3000);

            // Poll emergency feed every 8 seconds
            if (feedPollingInterval) clearInterval(feedPollingInterval);
            feedPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/live-feed/${currentSimulationId}?limit=10`);
                    if (response.ok) {
                        const data = await response.json();
                        updateEmergencyFeed(data.feed_items || []);
                    }
                } catch (error) {
                    console.error('Feed polling error:', error);
                }
            }, 8000);

            // Initial data fetch
            setTimeout(() => {
                if (metricsPollingInterval) {
                    fetch(`${API_BASE}/metrics/dashboard/${currentSimulationId}`)
                        .then(r => r.json())
                        .then(data => updateMetricsDisplay(data.dashboard_data || {}))
                        .catch(console.error);
                }
            }, 2000);
        }

        // Enhanced metrics display update
        function updateMetricsDisplay(metrics) {
            const timestamp = new Date().toLocaleTimeString();

            // Update panic index with color coding
            const panicValue = metrics.panic_index || 0;
            const panicEl = document.getElementById('panic-index');
            panicEl.textContent = panicValue + '%';
            panicEl.className = 'metric-value ' + (
                panicValue > 60 ? 'metric-panic-high' :
                    panicValue > 30 ? 'metric-panic-medium' : 'metric-panic-low'
            );
            document.getElementById('panic-timestamp').textContent = timestamp;

            // Update hospital capacity with color coding
            const hospitalValue = metrics.hospital_capacity || 65;
            const hospitalEl = document.getElementById('hospital-capacity');
            hospitalEl.textContent = hospitalValue + '%';
            hospitalEl.className = 'metric-value ' + (
                hospitalValue > 90 ? 'metric-hospital-critical' :
                    hospitalValue > 75 ? 'metric-hospital-warning' : 'metric-hospital-normal'
            );
            document.getElementById('hospital-timestamp').textContent = timestamp;

            // Update emergency response with color coding
            const responseValue = metrics.emergency_response || 95;
            const responseEl = document.getElementById('emergency-response');
            responseEl.textContent = responseValue + '%';
            responseEl.className = 'metric-value ' + (
                responseValue > 85 ? 'metric-response-excellent' :
                    responseValue > 70 ? 'metric-response-good' : 'metric-response-poor'
            );
            document.getElementById('response-timestamp').textContent = timestamp;

            // Update remaining metrics
            const populationValue = metrics.population_affected || 0;
            document.getElementById('population-affected').textContent = populationValue >= 1000 ?
                Math.floor(populationValue / 1000) + 'K' : populationValue;
            document.getElementById('population-timestamp').textContent = timestamp;

            document.getElementById('infrastructure-failures').textContent = metrics.infrastructure_failures || 0;
            document.getElementById('infrastructure-timestamp').textContent = timestamp;

            document.getElementById('public-trust').textContent = (metrics.public_trust || 80) + '%';
            document.getElementById('trust-timestamp').textContent = timestamp;

            document.getElementById('evacuation-compliance').textContent = (metrics.evacuation_compliance || 75) + '%';
            document.getElementById('evacuation-timestamp').textContent = timestamp;

            // Update alert level with color coding
            const alertLevel = metrics.alert_level || 'GREEN';
            const alertEl = document.getElementById('alert-level-display');
            alertEl.textContent = alertLevel;
            alertEl.className = 'metric-value alert-' + alertLevel.toLowerCase();
            document.getElementById('alert-level').textContent = alertLevel;
            document.getElementById('alert-timestamp').textContent = timestamp;

            // Log significant changes occasionally
            if (Math.random() < 0.4) {
                const logMessages = [
                    `Panic index: ${panicValue}% | Hospital capacity: ${hospitalValue}%`,
                    `Emergency response efficiency: ${responseValue}% | Alert level: ${alertLevel}`,
                    `Population affected: ${populationValue} | Infrastructure failures: ${metrics.infrastructure_failures || 0}`
                ];
                addLogEntry('INFO', logMessages[Math.floor(Math.random() * logMessages.length)]);
            }
        }

        // Update emergency feed
        function updateEmergencyFeed(feedItems) {
            const feedContainer = document.getElementById('emergency-feed');

            if (!feedItems || feedItems.length === 0) {
                feedContainer.innerHTML = `
                    <div class="no-data-placeholder">
                        <div class="icon">No Data</div>
                        <p>No emergency feed available</p>
                        <p style="font-size: 0.875rem;">Waiting for live updates...</p>
                    </div>
                `;
                return;
            }

            feedContainer.innerHTML = feedItems.map(item => {
                const timestamp = new Date(item.timestamp).toLocaleTimeString();
                const isEmergency = item.type === 'official_update' || item.source.includes('Emergency');

                return `
                    <div class="feed-item ${isEmergency ? 'emergency' : ''}">
                        <div class="feed-header">
                            <span class="feed-source ${isEmergency ? 'emergency' : ''}">${item.source}</span>
                            <span class="feed-timestamp">${timestamp}</span>
                        </div>
                        <div class="feed-content">${item.content}</div>
                        ${item.hashtags && item.hashtags.length > 0 ? `
                            <div style="margin-top: 8px;">
                                ${item.hashtags.map(tag => `<span class="hashtag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            if (feedItems.length > 0) {
                addLogEntry('INFO', `Emergency feed updated: ${feedItems.length} new items`);
            }
        }

        // Simulate social media feed
        function simulateSocialMediaFeed() {
            if (!currentSimulationId) return;

            const templates = [
                { content: "Hospital overflow detected. ICU at {hospital}% capacity. 💔", sentiment: "concern", user: "LocalResident" },
                { content: "Emergency services doing amazing work in {location} 👏", sentiment: "helpful", user: "ThankfulCitizen" },
                { content: "Can't reach family in {location}, please share if you see them", sentiment: "fear", user: "WorriedFamily" },
                { content: "FAKE: Government hiding real damage numbers! #coverup", sentiment: "misinformation", user: "Conspiracist" },
                { content: "Shelter at community center has space - warm food available", sentiment: "helpful", user: "Volunteer" }
            ];

            const currentMetrics = {
                hospital: document.getElementById('hospital-capacity').textContent.replace('%', ''),
                location: document.getElementById('location').value.split(',')[0]
            };

            const template = templates[Math.floor(Math.random() * templates.length)];
            const content = template.content.replace(/{(\w+)}/g, (match, key) => currentMetrics[key] || match);

            const post = {
                id: Date.now(),
                content: content,
                source: `@${template.user}${Math.floor(Math.random() * 1000)}`,
                timestamp: new Date(),
                sentiment: template.sentiment,
                engagement: {
                    likes: Math.floor(Math.random() * 200) + 10,
                    shares: Math.floor(Math.random() * 50) + 2,
                    comments: Math.floor(Math.random() * 100) + 5
                }
            };

            const existingPosts = JSON.parse(localStorage.getItem('socialFeed') || '[]');
            existingPosts.unshift(post);
            existingPosts.splice(15);
            localStorage.setItem('socialFeed', JSON.stringify(existingPosts));

            updateSocialMediaFeed(existingPosts);
        }

        // Update social media feed
        function updateSocialMediaFeed(posts) {
            const socialContainer = document.getElementById('social-feed');

            if (!posts || posts.length === 0) {
                socialContainer.innerHTML = `
                    <div class="no-data-placeholder">
                        <div class="icon">No Data</div>
                        <p>No social media activity</p>
                        <p style="font-size: 0.875rem;">AI-generated posts will appear here</p>
                    </div>
                `;
                return;
            }

            socialContainer.innerHTML = posts.map(post => {
                const timestamp = new Date(post.timestamp).toLocaleTimeString();
                const sentimentColor = {
                    'panic': '#ef4444',
                    'fear': '#f97316',
                    'concern': '#eab308',
                    'helpful': '#22c55e',
                    'misinformation': '#8b5cf6',
                    'official': '#3b82f6'
                }[post.sentiment] || '#64748b';

                return `
                    <div class="feed-item social">
                        <div class="feed-header">
                            <span class="feed-source social">${post.source}</span>
                            <span class="feed-timestamp">${timestamp}</span>
                        </div>
                        <div class="feed-content">${post.content}</div>
                        <div class="feed-engagement">
                            <span>❤️ ${post.engagement.likes}</span>
                            <span>🔄 ${post.engagement.shares}</span>
                            <span>💬 ${post.engagement.comments}</span>
                            <span style="margin-left: auto; background: ${sentimentColor}20; color: ${sentimentColor}; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">
                                ${post.sentiment.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update agent progress
        function updateAgentProgress() {
            agents.forEach(agent => {
                if (agent.status === 'active') {
                    agent.progress = Math.min(100, agent.progress + Math.random() * 4);
                    agent.efficiency = Math.max(85, Math.min(100, agent.efficiency + (Math.random() - 0.5) * 2));
                }
            });
            renderAgents();
        }

        // Render agents
        function renderAgents() {
            const agentsList = document.getElementById('agents-list');
            agentsList.innerHTML = agents.map(agent => `
                <div class="agent-card">
                    <div class="agent-header">
                        <div>
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-details">
                                ${agent.type === 'ADK' ? 'Google ADK' : 'Enhanced'} • Gemini 2.0 Flash • ${Math.round(agent.efficiency)}% efficiency
                            </div>
                        </div>
                        <div class="agent-status ${agent.status}">
                            ${agent.status}
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${agent.progress}%"></div>
                    </div>
                    <div style="text-align: right; font-size: 0.8rem; color: #94a3b8; margin-top: 5px;">
                        ${Math.round(agent.progress)}% complete
                    </div>
                </div>
            `).join('');
        }

        // Stop simulation
        function stopSimulation() {
            if (metricsPollingInterval) {
                clearInterval(metricsPollingInterval);
                metricsPollingInterval = null;
            }
            if (feedPollingInterval) {
                clearInterval(feedPollingInterval);
                feedPollingInterval = null;
            }

            currentSimulationId = null;
            document.getElementById('emergency-banner').classList.remove('active');
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('active-sims').textContent = '0';
            document.getElementById('sim-timestamp').textContent = '';

            // Hide live indicators
            document.getElementById('metrics-live-indicator').style.display = 'none';
            document.getElementById('emergency-live-indicator').style.display = 'none';
            document.getElementById('social-ai-indicator').style.display = 'none';

            // Reset agents
            agents.forEach(agent => {
                agent.status = 'standby';
                agent.progress = 0;
            });
            renderAgents();

            // Reset metrics
            updateMetricsDisplay({
                panic_index: 0,
                hospital_capacity: 65,
                emergency_response: 95,
                population_affected: 0,
                infrastructure_failures: 0,
                public_trust: 80,
                evacuation_compliance: 75,
                alert_level: 'GREEN'
            });

            // Clear feeds
            document.getElementById('emergency-feed').innerHTML = `
                <div class="no-data-placeholder">
                    <div class="icon">No Data</div>
                    <p>No emergency feed available</p>
                    <p style="font-size: 0.875rem;">Start a simulation to see live updates</p>
                </div>
            `;
            document.getElementById('social-feed').innerHTML = `
                <div class="no-data-placeholder">
                    <div class="icon">No Data</div>
                    <p>No social media activity</p>
                    <p style="font-size: 0.875rem;">AI-generated posts will appear here during simulation</p>
                </div>
            `;

            localStorage.removeItem('socialFeed');
            addLogEntry('INFO', 'Simulation stopped - All systems reset');
        }

        // Add log entry
        function addLogEntry(level, message) {
            const logArea = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'INFO': 'log-info',
                'SUCCESS': 'log-success',
                'WARNING': 'log-warning',
                'ERROR': 'log-error'
            }[level] || 'log-info';

            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span> 
                <span class="${colorClass}">${level}</span> - ${message}
            `;

            logArea.insertBefore(entry, logArea.firstChild);

            // Limit log entries
            while (logArea.children.length > 50) {
                logArea.removeChild(logArea.lastChild);
            }
        }

        // Start social media simulation when simulation is active
        setInterval(() => {
            if (currentSimulationId) {
                simulateSocialMediaFeed();
            }
        }, 12000);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (metricsPollingInterval) clearInterval(metricsPollingInterval);
            if (feedPollingInterval) clearInterval(feedPollingInterval);
            if (connectionCheckInterval) clearInterval(connectionCheckInterval);
        });

        // Load existing social feed on page load
        document.addEventListener('DOMContentLoaded', () => {
            const existingSocialFeed = JSON.parse(localStorage.getItem('socialFeed') || '[]');
            if (existingSocialFeed.length > 0) {
                updateSocialMediaFeed(existingSocialFeed);
            }
        });
    </script>
</body>

</html>
